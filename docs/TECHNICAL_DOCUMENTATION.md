# üèóÔ∏è –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Yandex Maps Workshop

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è)
2. [–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã](#–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã-—Å–∏—Å—Ç–µ–º—ã)
3. [API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](#api-–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è)
4. [–°–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª](#—Å–æ—Å—Ç–æ—è–Ω–∏—è-–∏-–∂–∏–∑–Ω–µ–Ω–Ω—ã–π-—Ü–∏–∫–ª)
5. [–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫](#–æ–±—Ä–∞–±–æ—Ç–∫–∞-–æ—à–∏–±–æ–∫)
6. [–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å](#–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
7. [–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å](#–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å)

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                        UI Layer                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                    Business Logic                          ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                     Data Layer                             ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                  External Services                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```kotlin
@Composable
fun App() {
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤
    val platformContext = rememberPlatformContext()
    val app = remember { CommonApp(...) }
    
    // 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è MapKit
    rememberAndInitializeMapKit(apiKey = BuildKonfig.mapkitToken)
        .bindToLifecycleOwner()
    
    // 3. –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    val mapScreenMutableState = remember { MapScreenMutableState() }
    
    // 4. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
    MaterialTheme {
        Box {
            MapWithPlacemarks(...)
            AnimationControlPanel(...)
            UserPlacemarksPanel(...)
            SearchPanel(...)
        }
    }
}
```

### –°–ª–æ–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

#### **Presentation Layer (UI)**
- **Compose Multiplatform** - –¥–µ–∫–ª–∞—Ä–∞—Ç–∏–≤–Ω—ã–π UI
- **Material Design 3** - –¥–∏–∑–∞–π–Ω —Å–∏—Å—Ç–µ–º–∞
- **Responsive Layout** - –∞–¥–∞–ø—Ç–∏–≤–Ω–∞—è –≤–µ—Ä—Å—Ç–∫–∞

#### **Business Logic Layer**
- **MapScreenMutableState** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º
- **SearchController** - –ª–æ–≥–∏–∫–∞ –ø–æ–∏—Å–∫–∞
- **YaGPTController** - –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ò–ò

#### **Data Layer**
- **MapState** - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–∞—Ä—Ç—ã
- **UserPlacemark** - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Ç–∫–∏
- **SearchResult** - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞

#### **External Services Layer**
- **Yandex MapKit** - –∫–∞—Ä—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ —Å–µ—Ä–≤–∏—Å—ã
- **YaGPT API** - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏–π
- **HTTP Client** - —Å–µ—Ç–µ–≤—ã–µ –∑–∞–ø—Ä–æ—Å—ã

---

## üîß –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### MapState

–£–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–∞—Ä—Ç—ã –∏ –∞–Ω–∏–º–∞—Ü–∏—è–º–∏.

```kotlin
class MapState(val coordinates: Point? = null) {
    var map by mutableStateOf<MapWindow?>(null)
    var onMapTap: ((Point) -> Unit)? = null
    var onMapLongTap: ((Point) -> Unit)? = null
    
    // –ê–Ω–∏–º–∞—Ü–∏–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è
    fun moveToPoint(point: Point, zoom: Float = 16.0f, duration: Float = 2.0f)
    fun flyToIsaacCathedral()
    fun moveToIsaacCathedral()
    fun moveToStPetersburg()
    fun moveToMoscow()
    
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    fun setupInputListener()
}
```

### MapScreenMutableState

–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

```kotlin
class MapScreenMutableState {
    val mapState by mutableStateOf(MapState())
    private var collection: MapObjectCollection? by mutableStateOf(null)
    private val placemarkObjects = mutableMapOf<String, PlacemarkMapObject>()
    
    // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –º–µ—Ç–∫–∏
    private val _userPlacemarks = mutableStateOf<List<UserPlacemark>>(emptyList())
    
    // –ü–æ–∏—Å–∫
    private val _searchResults = mutableStateOf<List<SearchResult>>(emptyList())
    private val _isSearching = mutableStateOf(false)
    private val _searchQuery = mutableStateOf("")
    
    // –ö–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã
    private val yaGPTController = YaGPTController(...)
    private val searchController = SearchController(...)
    
    // –ú–µ—Ç–æ–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
    fun addUserPlacemark(point: Point, title: String)
    fun removeUserPlacemark(id: String)
    fun clearUserPlacemarks()
    fun performSearch(query: String)
    fun generateDescriptionForUserPlacemark(placemark: UserPlacemark)
}
```

### YaGPTController

–£–ø—Ä–∞–≤–ª—è–µ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ–º —Å YaGPT API.

```kotlin
class YaGPTController(
    private val folderId: String,
    private val apiKey: String
) {
    private val httpClient = HttpClient()
    private val json = Json { 
        ignoreUnknownKeys = true 
        isLenient = true
    }
    
    suspend fun generatePlaceDescription(
        placeName: String, 
        address: String?
    ): String {
        // –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–º–ø—Ç–∞
        val systemPrompt = """
            –¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç—É—Ä–∏–∑–º—É –∏ –∏—Å—Ç–æ—Ä–∏–∏. –°–æ–∑–¥–∞–π –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ –∏ 
            –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –º–µ—Å—Ç–∞ –¥–ª—è —Ç—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
        """.trimIndent()
        
        val userPrompt = "–°–æ–∑–¥–∞–π –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –º–µ—Å—Ç–∞: $placeName (–∞–¥—Ä–µ—Å: $address)"
        
        // –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞
        val request = YaGPTRequest(
            modelUri = "gpt://$folderId/yandexgpt-lite",
            completionOptions = CompletionOptions(
                temperature = 0.7,
                maxTokens = "500"
            ),
            messages = listOf(
                Message("system", systemPrompt),
                Message("user", userPrompt)
            )
        )
        
        // –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
        val response = httpClient.post("https://llm.api.cloud.yandex.net/foundationModels/v1/completion") {
            headers {
                append("Authorization", "Api-Key $apiKey")
                append("x-folder-id", folderId)
            }
            contentType(ContentType.Application.Json)
            setBody(json.encodeToString(YaGPTRequest.serializer(), request))
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–∞
        return json.decodeFromString<YaGPTResponse>(response.body())
            .result.alternatives.firstOrNull()?.message?.text 
            ?: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ"
    }
}
```

### SearchController

–£–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–∏—Å–∫–æ–º –º–µ—Å—Ç (—Ç–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è - mock).

```kotlin
class SearchController(
    private val onSearchResults: (List<SearchResult>) -> Unit,
    private val onSearchError: (String) -> Unit
) {
    fun search(query: String, center: Point) {
        // –°–æ–∑–¥–∞–Ω–∏–µ mock —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        val mockResults = listOf(
            SearchResult(
                id = "mock_1",
                name = "–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞: $query",
                point = center,
                address = "–ê–¥—Ä–µ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω",
                category = "demo"
            ),
            SearchResult(
                id = "mock_2", 
                name = "–î—Ä—É–≥–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è: $query",
                point = PointFactory.create(
                    center.latitude + 0.001,
                    center.longitude + 0.001
                ),
                address = "–¢–µ—Å—Ç–æ–≤—ã–π –∞–¥—Ä–µ—Å",
                category = "demo"
            )
        )
        
        // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–æ–∏—Å–∫–∞
        CoroutineScope(Dispatchers.Main).launch {
            delay(1000)
            onSearchResults(mockResults)
        }
    }
    
    fun cancelSearch() {
        // –û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–∏—Å–∫–∞
    }
}
```

---

## üì° API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### YaGPT API

#### **Endpoint**
```
POST https://llm.api.cloud.yandex.net/foundationModels/v1/completion
```

#### **Headers**
```http
Authorization: Api-Key {YOUR_API_KEY}
x-folder-id: {YOUR_FOLDER_ID}
Content-Type: application/json
```

#### **Request Body**
```json
{
  "modelUri": "gpt://{folderId}/yandexgpt-lite",
  "completionOptions": {
    "stream": false,
    "temperature": 0.7,
    "maxTokens": "500"
  },
  "messages": [
    {
      "role": "system",
      "text": "–¢—ã - —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç—É—Ä–∏–∑–º—É –∏ –∏—Å—Ç–æ—Ä–∏–∏..."
    },
    {
      "role": "user", 
      "text": "–°–æ–∑–¥–∞–π –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –º–µ—Å—Ç–∞: {placeName}"
    }
  ]
}
```

#### **Response**
```json
{
  "result": {
    "alternatives": [
      {
        "message": {
          "role": "assistant",
          "text": "–û–ø–∏—Å–∞–Ω–∏–µ –º–µ—Å—Ç–∞..."
        },
        "status": "ALTERNATIVE_STATUS_FINAL"
      }
    ],
    "usage": {
      "inputTextTokens": "100",
      "completionTokens": "150", 
      "totalTokens": "250"
    },
    "modelVersion": "lite"
  }
}
```

### Yandex MapKit API

#### **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è**
```kotlin
rememberAndInitializeMapKit(apiKey = BuildKonfig.mapkitToken)
    .bindToLifecycleOwner()
```

#### **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–º–µ—Ä–æ–π**
```kotlin
// –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –∫–∞–º–µ—Ä—ã
val position = CameraPositionFactory.create(
    target = PointFactory.create(lat, lon),
    zoom = 16.0f,
    azimuth = 0.0f,
    tilt = 0.0f
)

// –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã
mapWindow.map.move(position)

// –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
val animation = AnimationFactory.create(
    type = AnimationType.SMOOTH,
    duration = 2.0f
)
mapWindow.map.move(position, animation, null)
```

#### **–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–∫**
```kotlin
val collection = mapWindow.map.mapObjects.addCollection()
val placemark = collection.addPlacemark()
placemark.geometry = PointFactory.create(lat, lon)
placemark.setIcon(image, style)
```

---

## üîÑ –°–æ—Å—Ç–æ—è–Ω–∏—è –∏ –∂–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª

### –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

```kotlin
@Composable
fun App() {
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    val platformContext = rememberPlatformContext()
    val app = remember { CommonApp(...) }
    
    // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MapKit
    rememberAndInitializeMapKit(apiKey = BuildKonfig.mapkitToken)
        .bindToLifecycleOwner()
    
    // 3. –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    val mapScreenMutableState = remember { MapScreenMutableState() }
    
    // 4. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    LaunchedEffect(Unit) {
        mapScreenMutableState.mapState.onMapTap = { point ->
            mapScreenMutableState.addUserPlacemark(point, "–ú–µ—Ç–∫–∞ ${...}")
        }
        
        mapScreenMutableState.mapState.onMapLongTap = { point ->
            mapScreenMutableState.addUserPlacemark(point, "–î–ª–∏–Ω–Ω–∞—è –º–µ—Ç–∫–∞ ${...}")
        }
    }
    
    // 5. –†–µ–Ω–¥–µ—Ä–∏–Ω–≥ UI
    MaterialTheme {
        Box {
            MapWithPlacemarks(...)
            AnimationControlPanel(...)
            UserPlacemarksPanel(...)
            SearchPanel(...)
        }
    }
}
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∫–∞—Ä—Ç—ã

```kotlin
@Composable
fun MapWithPlacemarks(
    mapScreenMutableState: MapScreenMutableState,
    placemarks: List<PlacemarkViewState>,
    selectedPlacemarkId: String?
) {
    val pinIconFactory = PinIconFactory.create()
    Map(state = mapScreenMutableState.mapState)

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –º–µ—Ç–æ–∫
    LaunchedEffect(placemarks, selectedPlacemarkId) {
        val collection = mapScreenMutableState.collection()
        
        // –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –º–µ—Ç–æ–∫
        val actualIds = placemarks.map(PlacemarkViewState::id).toSet()
        val existingIds = mapScreenMutableState.allPlacemarkObjects()
        val toRemoveIds = (existingIds - actualIds)
        
        toRemoveIds.forEach(mapScreenMutableState::removePlacemarkObject)
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ/—Å–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç–æ–∫
        placemarks.forEach { placemarkModel ->
            val id = placemarkModel.id
            val obj = mapScreenMutableState.getPlacemarkObject(id)
            val isSelected = id == selectedPlacemarkId

            val (image, pinStyle) = pinIconFactory.iconAndStyleFor(
                iconId = placemarkModel.iconId,
                selected = isSelected
            )

            if (obj == null) {
                collection.addPlacemark().also { mapObject ->
                    mapObject.geometry = placemarkModel.position
                    mapObject.setIcon(image, pinStyle)
                    mapScreenMutableState.setPlacemarkObject(id, mapObject)
                }
            } else {
                if (obj.geometry != placemarkModel.position) {
                    obj.geometry = placemarkModel.position
                }
                obj.setIcon(image, pinStyle)
            }
        }
    }
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –ò—Å–∞–∞–∫–∏–µ–≤—Å–∫–æ–≥–æ —Å–æ–±–æ—Ä–∞
    LaunchedEffect(Unit) {
        val collection = mapScreenMutableState.collection()
        
        if (mapScreenMutableState.getPlacemarkObject("isaac_cathedral_extra") == null) {
            val isaacCathedralPoint = PointFactory.create(59.9343, 30.3061)
            
            collection.addPlacemark().also { mapObject ->
                mapObject.geometry = isaacCathedralPoint
                val iconAndStyle = pinIconFactory.iconAndStyleFor(IconId.DefaultIcon1, false)
                mapObject.setIcon(iconAndStyle.first, iconAndStyle.second)
                mapScreenMutableState.setPlacemarkObject("isaac_cathedral_extra", mapObject)
            }
        }
    }
    
    // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ –º–µ—Ç–∫–∞–º–∏
    LaunchedEffect(mapScreenMutableState.getUserPlacemarks()) {
        val collection = mapScreenMutableState.collection()
        val userPlacemarks = mapScreenMutableState.getUserPlacemarks()
        
        userPlacemarks.forEach { userPlacemark ->
            if (mapScreenMutableState.getPlacemarkObject(userPlacemark.id) == null) {
                collection.addPlacemark().also { mapObject ->
                    mapObject.geometry = userPlacemark.point
                    val (icon, style) = pinIconFactory.iconAndStyleFor(IconId.DefaultIcon3, false)
                    mapObject.setIcon(icon, style)
                    mapScreenMutableState.setPlacemarkObject(userPlacemark.id, mapObject)
                }
            }
        }
    }
}
```

---

## ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ YaGPT

```kotlin
suspend fun generatePlaceDescription(placeName: String, address: String?): String {
    return try {
        // ... –ª–æ–≥–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ...
        
        val response = httpClient.post("https://llm.api.cloud.yandex.net/foundationModels/v1/completion") {
            // ... –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ ...
        }
        
        val yaGPTResponse = json.decodeFromString<YaGPTResponse>(response.body())
        yaGPTResponse.result.alternatives.firstOrNull()?.message?.text 
            ?: "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ"
            
    } catch (e: Exception) {
        println("–û—à–∏–±–∫–∞ YaGPT: ${e.message}")
        "–û–ø–∏—Å–∞–Ω–∏–µ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–∑–∂–µ..."
    }
}
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–æ–∏—Å–∫–∞

```kotlin
private val searchController = SearchController(
    onSearchResults = { results ->
        _searchResults.value = results
        _isSearching.value = false
        generateDescriptionsForResults(results)
    },
    onSearchError = { error ->
        println("–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: $error")
        _isSearching.value = false
        // TODO: –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    }
)
```

### –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∫–∞—Ä—Ç—ã

```kotlin
fun moveToPoint(point: Point, zoom: Float = 16.0f, duration: Float = 2.0f) {
    try {
        map?.let { mapWindow ->
            val animation = AnimationFactory.create(
                type = AnimationType.SMOOTH, 
                duration = duration
            )
            val position = CameraPositionFactory.create(
                target = point, 
                zoom = zoom
            )
            mapWindow.map.move(position, animation, null)
        }
    } catch (e: Exception) {
        println("–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∫–∞—Ä—Ç—ã: ${e.message}")
    }
}
```

---

## ‚ö° –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∞–Ω–∏–º–∞—Ü–∏–π

```kotlin
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–ª–∞–≤–Ω—ã—Ö –∞–Ω–∏–º–∞—Ü–∏–π
val animation = AnimationFactory.create(
    type = AnimationType.SMOOTH,  // –ü–ª–∞–≤–Ω–∞—è –∞–Ω–∏–º–∞—Ü–∏—è
    duration = 2.0f               // –û–ø—Ç–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
)

// –¶–µ–ø–æ—á–∫–∞ –∞–Ω–∏–º–∞—Ü–∏–π –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
fun flyToIsaacCathedral() {
    map?.let { mapWindow ->
        // 1. –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –æ–±—â–µ–º—É –≤–∏–¥—É
        val overviewPosition = CameraPositionFactory.create(
            target = PointFactory.create(59.9343, 30.3061),
            zoom = 8.0f
        )
        mapWindow.map.move(overviewPosition, null, null)
        
        // 2. –ü–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ —Ü–µ–ª–∏
        Handler(Looper.getMainLooper()).postDelayed({
            val targetPosition = CameraPositionFactory.create(
                target = PointFactory.create(59.9343, 30.3061),
                zoom = 16.0f
            )
            val animation = AnimationFactory.create(
                type = AnimationType.SMOOTH,
                duration = 3.0f
            )
            mapWindow.map.move(targetPosition, animation, null)
        }, 500)
    }
}
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç—å—é

```kotlin
// –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –º–µ—Ç–æ–∫
fun removePlacemarkObject(id: String) {
    placemarkObjects[id]?.let { placemark ->
        collection()?.remove(placemark)
    }
    placemarkObjects.remove(id)
}

// –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫
fun clearUserPlacemarks() {
    _userPlacemarks.value.forEach { userPlacemark ->
        removePlacemarkObject(userPlacemark.id)
    }
    _userPlacemarks.value = emptyList()
}
```

### –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

```kotlin
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ—Ä—É—Ç–∏–Ω –¥–ª—è —Ç—è–∂–µ–ª—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
private fun generateDescriptionsForResults(results: List<SearchResult>) {
    CoroutineScope(Dispatchers.Main).launch {
        results.forEach { result ->
            launch {
                try {
                    val description = yaGPTController.generatePlaceDescription(
                        placeName = result.name,
                        address = result.address
                    )
                    
                    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI –≤ –≥–ª–∞–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ
                    val updatedResult = result.copy(description = description)
                    updateSearchResult(updatedResult)
                    
                } catch (e: Exception) {
                    println("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è: ${e.message}")
                }
            }
        }
    }
}
```

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ó–∞—â–∏—Ç–∞ API –∫–ª—é—á–µ–π

```kotlin
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ BuildKonfig –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–ª—é—á–µ–π
buildkonfig {
    val folderId: String by rootProject.extra
    val gptToken: String by rootProject.extra
    val mapkitToken: String by rootProject.extra
    
    defaultConfigs {
        buildConfigField(FieldSpec.Type.STRING, "folderId", folderId)
        buildConfigField(FieldSpec.Type.STRING, "gptToken", gptToken)
        buildConfigField(FieldSpec.Type.STRING, "mapkitToken", mapkitToken)
    }
}

// –í –∫–æ–¥–µ
private val yaGPTController = YaGPTController(
    folderId = BuildKonfig.folderId,
    apiKey = BuildKonfig.gptToken
)
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

```kotlin
fun performSearch(query: String) {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –ø—É—Å—Ç—ã–µ –∑–∞–ø—Ä–æ—Å—ã
    if (query.isBlank()) return
    
    // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –∑–∞–ø—Ä–æ—Å–∞
    if (query.length > 100) {
        println("–°–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å")
        return
    }
    
    _isSearching.value = true
    _searchQuery.value = query
    
    val center = PointFactory.create(59.9343, 30.3061)
    searchController.search(query, center)
}
```

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Å–µ—Ç–µ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤

```kotlin
// –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ HTTPS
val response = httpClient.post("https://llm.api.cloud.yandex.net/foundationModels/v1/completion") {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    headers {
        append("Authorization", "Api-Key $apiKey")
        append("x-folder-id", folderId)
    }
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    contentType(ContentType.Application.Json)
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞
    setBody(json.encodeToString(YaGPTRequest.serializer(), request))
}
```

---

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π

```kotlin
// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ—Ç–æ–∫
fun addUserPlacemark(point: Point, title: String = "–ù–æ–≤–∞—è –º–µ—Ç–∫–∞") {
    println("–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–π –º–µ—Ç–∫–∏: $title –≤ —Ç–æ—á–∫–µ (${point.latitude}, ${point.longitude})")
    
    val userPlacemark = UserPlacemark(
        id = "user_${System.currentTimeMillis()}",
        point = point,
        title = title,
        description = "–ú–µ—Ç–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
    )
    
    _userPlacemarks.value = _userPlacemarks.value + userPlacemark
    println("–ú–µ—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ —Å ID: ${userPlacemark.id}")
}

// –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–Ω–∏–º–∞—Ü–∏–π
fun moveToPoint(point: Point, zoom: Float = 16.0f, duration: Float = 2.0f) {
    println("–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã –∫ —Ç–æ—á–∫–µ (${point.latitude}, ${point.longitude}) —Å –∑—É–º–æ–º $zoom")
    
    try {
        map?.let { mapWindow ->
            val animation = AnimationFactory.create(
                type = AnimationType.SMOOTH, 
                duration = duration
            )
            val position = CameraPositionFactory.create(
                target = point, 
                zoom = zoom
            )
            mapWindow.map.move(position, animation, null)
            println("–ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–ø—É—â–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
        }
    } catch (e: Exception) {
        println("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã: ${e.message}")
    }
}
```

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

```kotlin
// –ò–∑–º–µ—Ä–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏–π
private fun generateDescriptionsForResults(results: List<SearchResult>) {
    val startTime = System.currentTimeMillis()
    
    CoroutineScope(Dispatchers.Main).launch {
        val completedCount = results.count { result ->
            launch {
                try {
                    val description = yaGPTController.generatePlaceDescription(
                        placeName = result.name,
                        address = result.address
                    )
                    
                    val updatedResult = result.copy(description = description)
                    updateSearchResult(updatedResult)
                    
                } catch (e: Exception) {
                    println("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–ø–∏—Å–∞–Ω–∏—è –¥–ª—è ${result.name}: ${e.message}")
                }
            }
            true
        }
        
        val endTime = System.currentTimeMillis()
        val totalTime = endTime - startTime
        
        println("–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ–ø–∏—Å–∞–Ω–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞: $completedCount –∏–∑ ${results.size} –∑–∞ ${totalTime}ms")
    }
}
```

---

## üîÆ –ü–ª–∞–Ω—ã —Ä–∞–∑–≤–∏—Ç–∏—è

### –ö—Ä–∞—Ç–∫–æ—Å—Ä–æ—á–Ω—ã–µ —Ü–µ–ª–∏ (1-2 –º–µ—Å—è—Ü–∞)

- [ ] **–†–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Yandex Search API**
- [ ] **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏–π YaGPT**
- [ ] **–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫**
- [ ] **–≠–∫—Å–ø–æ—Ä—Ç/–∏–º–ø–æ—Ä—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö –º–µ—Ç–æ–∫**

### –°—Ä–µ–¥–Ω–µ—Å—Ä–æ—á–Ω—ã–µ —Ü–µ–ª–∏ (3-6 –º–µ—Å—è—Ü–µ–≤)

- [ ] **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ iOS –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã**
- [ ] **Web –≤–µ—Ä—Å–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**
- [ ] **–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –∞–Ω–∏–º–∞—Ü–∏–∏ –∏ —ç—Ñ—Ñ–µ–∫—Ç—ã**
- [ ] **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–æ—Ü–∏–∞–ª—å–Ω—ã–º–∏ —Å–µ—Ç—è–º–∏**

### –î–æ–ª–≥–æ—Å—Ä–æ—á–Ω—ã–µ —Ü–µ–ª–∏ (6+ –º–µ—Å—è—Ü–µ–≤)

- [ ] **AR/VR –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –¥–ª—è –º–µ—Ç–æ–∫**
- [ ] **–ú–∞—à–∏–Ω–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –¥–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏–∏**
- [ ] **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å IoT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏**
- [ ] **–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞**

---

*–î–æ–∫—É–º–µ–Ω—Ç –æ–±–Ω–æ–≤–ª–µ–Ω: –î–µ–∫–∞–±—Ä—å 2024*
